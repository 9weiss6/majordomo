<script type="text/javascript" src="<#ROOTHTML#>js/jquery.tiny-pubsub.js"></script>
<script language="javascript">
 var wsTimer=0;
 var startedWebSockets=0;

        function startWebSockets() {
            var loc = window.location, new_uri;
            var serverUrl='';
            if (loc.protocol === "https:") {
                    serverUrl = "wss:";
            } else {
                    serverUrl = "ws:";
            }
            serverUrl += "//" + loc.host + ':<#WEBSOCKETS_PORT#>/majordomo';

            if (window.MozWebSocket) {
              wsSocket = new MozWebSocket(serverUrl);
            } else if (window.WebSocket) {
              wsSocket = new WebSocket(serverUrl);
            }
            wsSocket.binaryType = 'blob';
            wsSocket.onopen = function(msg) {
             ///connected
              console.log('WS connected');
              startedWebSockets=1;
              clearTimeout(wsTimer);
              $.publish('wsConnected');
            };
            wsSocket.onmessage = function(msg) {
              console.log('WS data');
              var response;
              response = JSON.parse(msg.data);
              $.publish('wsData', response);
              return;
            };
            wsSocket.onclose = function(msg) {
              //disconnected
              console.log('WS disconnected');
              startedWebSockets=0;
              wsTimer=setTimeout('startWebSockets();', 5*1000);
              $.publish('wsDisconnected', []);
              return;
            };
        }

 $(document).ready(function(){
  [#if "<#DISABLE_WEBSOCKETS#>"!="1"#]
   startWebSockets();
  [#endif#]
 });

         
</script>

